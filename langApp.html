<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width" />
    <title>Lang Edit</title>

    <!-- JQuery -->
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous"></script>
    <!-- Js Bootstrap -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh"
        crossorigin="anonymous"></script>
    <!-- Cloud FireStore for Lang -->
    <script src="https://www.gstatic.com/firebasejs/4.6.0/firebase.js"></script>
    
    <!-- CSS Fontawesome -->
    <script src="https://use.fontawesome.com/ceaa390e68.js"></script>
    <!-- CSS Bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb"
        crossorigin="anonymous">

    <script>
        //Variable con la pagina que se va a editar
        var basePage = "demoPruebasMiguel";

        // Initialize Cloud FireBase for lang
        firebase.initializeApp({
            apiKey: "AIzaSyA5dxS5U33CDrtAuxmnp80RTJzKiAoHC1U",
            authDomain: "langdigin.firebaseapp.com",
            databaseURL: "https://langdigin.firebaseio.com",
            storageBucket: "langdigin.appspot.com"
        });

        // Iniciaizamos variables y creamos otras para el login
        var db = firebase.database();
        var Auth = firebase.auth();
        var auth = null;

        //Creacion de objeto Bundle
        var bundle = { "en": {}, "es": {} };

        //Actualizacion en momento real para el idioma en en objecto Bundle
        var pageData = db.ref(basePage);
        pageData.on('value', function (snapshot) {
            bundle = { "en": {}, "es": {} };
            $.each(snapshot.val(), function (index, element) {

                //Se agregan los elementos con su index
                bundle[index] = element;

                //Se modifican los inputs si es que cambian
                fillInputs(lngSelected);
                //Se llena el select con los idiomas
                if (userExist) {
                    deleteSelect();
                }
                fillSelect();
            });
        });

        //Si el usuario ya existe se mantiene logIn
        var userExist = false;
        Auth.onAuthStateChanged(function (user) {
            window.user = user; // user is undefined if no user signed in
            if (user) {
                //Desplega la informacion para el usuario existente
                $('.unauthenticated, .userAuth').toggleClass('unauthenticated').toggleClass('authenticated');
                //console.log("jalo?");
                userExist = true;
            }
        });

    </script>

    <style type="text/css">
        .authenticated {
            display: block;
        }

        .logIn {
            margin-top: 10px;
        }

        .logOut {
            margin-top: 10px;
        }

        .unauthenticated {
            display: none;
        }

        .selectContainer {
            padding-top: 20px;
        }
    </style>

</head>

<body>

    <div class="container">
        <span class="userAuth authenticated pull-right logIn">
            <button type="button" class="btn btn-success" data-toggle="modal" data-target="#loginModal">Login</button>
        </span>
        <span class="unauthenticated pull-right logOut">
            <button type="button" class="btn btn-danger unauthenticated" id="signOut">Log Out</button>
        </span>
        <h1>Configuracion del lang</h1>
        <hr>
        <div class="unauthenticated">
            <div class="row">
                <div class="col-md-12">
                    <h1>Form</h1>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <button href="javascript:void(0)" type="button" class="btn btn-primary" id="btnUpload">Subir Cambios</button>
                    <button type="button" class="btn btn-warning" data-toggle="modal" data-target="#addLangModal" style="float: right;">Agregar Idioma</button>
                    <button type="button" class="btn btn-info" data-toggle="modal" data-target="#addKeyValueModal" style="float: right;margin-right: 5px;">Agregar Variable</button>
                </div>
            </div>
            <div class="row selectContainer">
                <div class="col-md-12 form-group">
                    <label>Selecione un Idioma</label>
                    <div class="form-inline">
                        <select id="selectLang" class="form-control col-8">
                            <option></option>
                        </select>
                        <button type="button" class="col-2 offset-md-2 btn btn-outline-danger" id="btn-eliminarIdioma">Eliminar Idioma</button>
                    </div>
                </div>
            </div>
            <form id="formContainer" class="container row">
            </form>
        </div>
    </div>

    <!-- Modal para borrar -->
    <div class="modal fade" id="deletMessaje" tabindex="-1" role="dialog" aria-labelledby="Eliminas" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="borrarModalLabel">Seguro que quieres Eliminarla esta variable?</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-danger btn-eliminar">Eliminar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para mensajes -->
    <div class="modal fade" id="messageModal" tabindex="-1" role="dialog" aria-labelledby="Message" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="messageModalLabel">Message</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-footer">
                    <div class="pre-auth">
                        <button type="button" class="btn btn-default pull-left" data-dismiss="modal">Close</button>
                    </div>
                    <div class="post-auth"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para el inicio de secion -->
    <div class="modal fade" id="loginModal" tabindex="-1" role="dialog" aria-labelledby="Login" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="loginModalLabel">Login</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="recipient-name" class="control-label">Email:</label>
                        <input type="text" class="form-control" id="loginEmail">
                    </div>
                    <div class="form-group">
                        <label for="message-text" class="control-label">Password:</label>
                        <input type="password" class="form-control" id="loginPassword">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="doLogin">Login</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para el agregar idioma -->
    <div class="modal fade" id="addLangModal" tabindex="-1" role="dialog" aria-labelledby="Agregar Idioma" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="addLangModalLabel">Agregar Idioma</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="recipient-name" class="control-label">Nuevo idioma:</label>
                        <input type="text" class="form-control" id="newLang">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="agregarLang">Agregar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para agregar un nuevo key y value -->
    <div class="modal fade" id="addKeyValueModal" tabindex="-1" role="dialog" aria-labelledby="Login" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="keyValueLabel">Agregar una variable nueva</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="recipient-name" class="control-label">key:</label>
                        <input type="text" class="form-control" id="newkey">
                    </div>
                    <div class="form-group">
                        <label for="message-text" class="control-label">Value:</label>
                        <input type="text" class="form-control" id="newValue" value="xxx">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="agregarKeyValue">Agregar</button>
                </div>
            </div>
        </div>
    </div>


<script>
    //Variables de nombre de idiomas en base de datos
    var lngSelected;

    $(document).ready(function () {

        //Cuando cambia el idioma selecionado cambia los inputs y la variable
        $('#selectLang').change(function () {
            lngSelected = $('#selectLang').val();
            fillInputs(lngSelected);
            $('#formContainer').show();
        });

        //Cuando le des click al btn se actuliza firebase
        $("#btnUpload").click(function (e) {
            e.preventDefault();

            //Se guarda el areglo de los inputs
            var NewBundle = getData();

            //Actulizar firebase 
            actulizarFirebase(lngSelected, NewBundle);

            //Da confirmacion
            //alert("Se actulizado el lenguaje de: " + lngSelected);
        });

        //Para cerrar secion
        $("#signOut").click(function (e) {
            e.preventDefault();

            firebase.auth().signOut().then(function () {
                // Sign-out successful.
            }, function (error) {
                // An error happened.
            });

            //Redeciona a la pagina de login
            document.location.href = "/home/getview/lang";
        });

        //Para iniciar seccion
        $('#doLogin').on('click', function (e) {
            e.preventDefault();

            //Se esconde el modal cuando le das click a login
            $('#loginModal').modal('hide');
            //Muestra el mensaje de si se pudo o no iniciar seccion
            $('#messageModalLabel').html(spanText('<i class="fa fa-cog fa-spin"></i>', ['center', 'info']));
            $('#messageModal').modal('show');

            //Se valida que se ingreso informacion a el correo y pass
            if ($('#loginEmail').val() != '' && $('#loginPassword').val() != '') {
                //se almacena la infomarcion
                var data = {
                    email: $('#loginEmail').val(),
                    password: $('#loginPassword').val()
                };
                //Se manda a firebase para authenticarlo
                firebase.auth().signInWithEmailAndPassword(data.email, data.password)
                    .then(function (authData) {
                        //Si si se pudo conectar
                        //console.log("Authenticated successfully with payload:", authData);
                        auth = authData;
                        $('#messageModalLabel').html(spanText('Success!', ['center', 'success']))
                        setTimeout(function () {
                            $('#messageModal').modal('hide');
                            //Ya existe una funcion que esta checando en tiempo real que si este en seccion
                        }, 500);
                    })
                    .catch(function (error) {
                        //Si no se pudo conectar
                        console.log("Login Failed!", error);
                        $('#messageModalLabel').html(spanText('ERROR: ' + error.code, ['danger']))
                    });
            }
        });

        //Para agregar idioma
        $('#agregarLang').on('click', function (e) {
            e.preventDefault();

            //Se esconde el modal cuando le das click a login
            $('#addLangModal').modal('hide');

            //Se valida que se ingreso informacion a el correo y pass
            if ($('#newLang').val() != '') {
                //se almacena la infomarcion
                var nuevoIdioma = $('#newLang').val();
                setTimeout(function () {
                    //Se agregar el idioma y se copia la info de el de en
                    agregarIdiomaFirebase(nuevoIdioma);
                }, 500);
            } else {
                //Si no se pudo conectar
                console.log("Error al subir el idioma");
                $('#messageModalLabel').html(spanText('ERROR: error al subir el idioma', ['danger']))
            }
        });

        //Para agregar idioma
        $('#agregarKeyValue').on('click', function (e) {
            e.preventDefault();

            //Se esconde el modal cuando le das click a login
            $('#addKeyValueModal').modal('hide');

            //Se valida que se ingreso informacion a el correo y pass
            if ($('#newkey').val() != '' && $('#newValue').val() != '') {
                //se almacena la infomarcion
                var key = $('#newkey').val();
                var val = $('#newValue').val();
                setTimeout(function () {
                    //Se agregar el idioma y se copia la info de el de en
                    agregarVariableFirebase(key, val);
                }, 500);
            } else {
                //Si no se pudo conectar
                console.log("Error al subir la variable");
                $('#messageModalLabel').html(spanText('ERROR: Error al subir la variable', ['danger']))
            }
        });

        // Eliminar idioma selecionado
        $('#btn-eliminarIdioma').on('click', function (e) {
            e.preventDefault();

            //Se corre la funcion para eliminar el idioma
            deleteModal(lngSelected, true);//El true es para decirle que si es un idioma

        });

    });


    //Crea spans para desplegar mensajes
    function spanText(textStr, textClasses) {
        var classNames = textClasses.map(c => 'text-' + c).join(' ');
        return '<span class="' + classNames + '">' + textStr + '</span>';
    }

    //Llean el select con las opciones de idioma
    function fillSelect() {

        //Se guarda el objeto en una nueva variable
        var array = bundle;
        // Variable para identificar la primera vuelta
        var firstRun = true;
        // Primer input para forzar al usaurio a selecionar una opcion
        var blankOption = '<option disabled selected value>' + '-- select an option --' + '</option>';
        //Se lee las primeras llaves del objecto bundle que en este caso son los idiomas
        $('#selectLang').html($.map(array, function (val, key) {
            //Se hace un if para agregar el input disable solo en la primera vuelta
            if (firstRun) {
                firstRun = false;
                return blankOption + '<option value="' + key + '">' + key + '</option>';
            }
            return '<option value="' + key + '">' + key + '</option>';

        }).join(''));

    }

    //Funcion para borrar select y actulizacion
    function deleteSelect() {
        //Para cuando se actulize la base de datos sepas
        //Se muestra un modal
        $('#messageModal').modal('show');
        //Se pone un icono de carga
        $('#messageModalLabel').html(spanText('<i class="fa fa-cog fa-spin"></i>', ['center', 'info']));
        //Borra todo el select
        $('#selectLang').find('option').remove().end();
        //Se esconde el form
        $('#formContainer').hide();

        //Empieza time out
        setTimeout(function () {
            //Se muestra el mensaje
            $('#messageModalLabel').html(spanText('Base de datos actulizada', ['center', 'success']));
            //Esconde el modal
            $('#messageModal').modal('hide');
        }, 800);//Fin Timeout
    }

    //Toma todos los input con su valor y los mete en un objecto
    //Esto para luego actulizar la base de datos
    function getData() {
        var newBundle = [];

        $("form#formContainer :input").each(function () {
            var input = $(this);
            var key = input.attr('id');
            var keyValue = $('#' + key + ' :input').val();
            newBundle[key] = keyValue;
        });

        return newBundle;
    }

    //Funcion para actulizacion el idioma de  firebase
    function actulizarFirebase(language, newInfo) {
        var refIndex = basePage + "/" + language;
        db.ref(refIndex)
            .set(newInfo);
    }

    //Funcion para agregar un idioma al firebase
    function agregarIdiomaFirebase(language) {
        var newLangObject = [];
        //Recorre todas las llaves de objeto para cambiar su value a "xxx"
        Object.keys(bundle.en).forEach(function (key) {
            newLangObject[key] = "xxx";
        });

        //Crea el nuevo idioma con valor predeterminado de "xxx"
        var refIndex = basePage + "/" + language;
        db.ref(refIndex)
            .set(newLangObject);
    }

    //Funcion para agregar elementos al firebase
    function agregarVariableFirebase(keyVal, val) {
        var refIndex = basePage + "/";
        //Recorre todas las llaves de firebase
        Object.keys(bundle).forEach(function (key) {
            db.ref(refIndex + key).update({ [keyVal]: val });
        });

    }

    //Funcion para borrar un elemento de firebase
    function deleteElement(keyToDelete) {
        //Se borra el input del form en el html
        $("#" + keyToDelete).remove();

        //Se borra el elemento de todos los idiomas en la base de datos
        var refIndex = basePage + "/";
        Object.keys(bundle).forEach(function (key) {
            db.ref(refIndex + key).child(keyToDelete).remove();

            //Lo borra local mente tambien para que sea mas rapido
            Object.keys(bundle[key]).forEach(function (key) {
                delete bundle[keyToDelete];
            });
        });

        //Se esconde el modale
        $('#deletMessaje').modal('hide');
    }

    //Funcion para borrar un idioma de firebase
    function deleteLang(language) {
        // Se borra el idioma
        var refIndex = basePage + "/" + language;
        db.ref(refIndex).remove();

        //Se esconde el modale
        $('#deletMessaje').modal('hide');
    }

    //Cambia los inputs por otros
    function fillInputs(lng) {

        //Borra todo el form
        $('#formContainer')[0].reset();

        //Pone en la variable la parte del objecto a generar
        var arr = bundle[lng];

        //Vuelvea a crear el form
        $.each(arr, function (key, value) {
            //display the key and value pair
            addInput(key, value);
        });
    }

    //Funcion abrir modal de advertencia antes de eliminar
    function deleteModal(id, deleteLang) {
        //Se checa si es un idoma o una variable
        if (!deleteLang) {
            //Si es una variable
            // Se agrega el id al modal de eliminar
            $(".btn-eliminar").attr('id', id);

            //Se agrega la funcion para borrar el 
            $(".btn-eliminar").attr('onclick', 'deleteElement(this.id);');

            //Se edita el mensaje
            $('#borrarModalLabel').html(spanText('Seguro que quieres Eliminar la variable: ' + id, ['danger']));

        } else if (deleteLang) {
            //Si es un idioma
            // Se agrega el idioma como id
            $(".btn-eliminar").attr('id', id);

            //Se agrega la funcion para borrar el idioma al btn
            $(".btn-eliminar").attr('onclick', 'deleteLang(this.id);');

            //Se edita el mensaje
            $('#borrarModalLabel').html(spanText('Seguro que quieres Eliminar este idioma: ' + id, ['danger']));
        }

        //Se abre el modale
        $('#deletMessaje').modal('show');
    }

    // Crea los inputs del form
    function addInput(key, keyValue) {
        //Para la actulizacion en tiempo real de los inputs, evita tambien que se dupliquen
        if ($('#' + key + ' :input').length) {
            $('#' + key + ' :input').val(keyValue);
        } else {

            // Se crea la label
            var label = $("<label />", {
                addClass: "col-form-label",
                id: key,
                append: [key + ": "]
            });

            // Se cre el input
            var input = $('<input />', {
                addClass: "form-control",
                type: "text",
                name: key,
                id: key,
                value: keyValue
            });

            // Se crea el button que va dentro el input
            var buttonInput = $('<button />', {
                addClass: "btn btn-outline-danger",
                type: "button",
                id: key,
                onClick: "deleteModal(this.id);",
                append: ["Borrar"]
            });

            // Se crea el wrapper del button
            var spanInput = $('<span />', {
                addClass: "input-group-btn",
                append: [buttonInput]
            });

            // Se crea el wrapper del input con el button
            var divInput = $('<div />', {
                addClass: "input-group",
                id: "inputContainer",
                append: [input, spanInput]
            });

            // Se crea el wrapper de todo el form group
            // y se agregar todo el contenido
            $("<div />", {
                addClass: "form-group col-6",
                id: key,
                append: [label, divInput],
                appendTo: "#formContainer"
            });
        }
    }

</script>

    <!-- JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh"
        crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ"
        crossorigin="anonymous"></script>

</body>

</html>